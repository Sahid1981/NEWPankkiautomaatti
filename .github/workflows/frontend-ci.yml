
name: frontend-ci

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    # Projektin ty√∂kansio
    defaults:
      run:
        working-directory: ./bank-automat

    env:
      # Testien tarvitsemat muuttujat
      BACKEND_IP: ${{ secrets.SERVER_HOST }}
      BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
      TEST_CARD: ${{ secrets.TEST_CARD }}
      TEST_PIN: ${{ secrets.TEST_PIN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # install Qt
      - name: Install Qt 6.5.2
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.2'
          target: desktop
          modules: 'qtbase qttools qtsvg qtdeclarative'
          cache: true

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake build-essential

      - name: Install Xvfb and XCB/GL deps
        run: |
          sudo apt-get install -y xvfb x11-utils \
            libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
            libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 \
            libgl1 libegl1

      - name: Configure (CMake + Ninja, Release)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests (headless via Xvfb)
        uses: coactions/setup-xvfb@v1
        with:
          run: ctest --test-dir build --output-on-failure

      - name: Deploy to server via scp
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: "./bank-automat/build/*"
          target: ${{ secrets.SERVER_DEPLOY_PATH }}
